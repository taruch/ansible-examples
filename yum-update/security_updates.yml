---
- name: Install Security Patches
  hosts: "{{ _host }}"
  become: true
  gather_facts: true
  vars:
    allow_reboot: true 

  tasks:
    - name: RedHat Security Updates execution block
      when: ansible_os_family == "RedHat"
      block:

        - name: Get packages
          ansible.builtin.package_facts:
          check_mode: false

        - name: Get services
          ansible.builtin.service_facts:
          check_mode: false

        - name: Upgrade all security related packages (yum)
          ansible.builtin.yum:
            name: '*'
            security: true
            state: latest  # noqa: package-latest - Intended to update packages to latest
            exclude: "{{ exclude_packages }}"
          when: ansible_pkg_mgr == "yum"
          register: patchingresult_yum

        - name: Upgrade all security related packages (dnf)
          ansible.builtin.dnf:
            name: '*'
            security: true
            state: latest  # noqa: package-latest - Intended to update packages to latest
            exclude: "{{ exclude_packages }}"
          when: ansible_pkg_mgr == "dnf"
          register: patchingresult_dnf
    
        - name: Check to see if we need a reboot
          register: needs_restarting
          ansible.builtin.command: "dnf needs-restarting -r -s"
          changed_when: needs_restarting.rc == 1
          failed_when: needs_restarting.rc > 1
          notify: Reboot host
          check_mode: false

        - name: Reboot Server if Necessary
          ansible.builtin.reboot:
          when:
            - needs_restarting.rc == 1
            - allow_reboot
